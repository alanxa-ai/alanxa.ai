name: Deploy to VPS

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  deploy:
    name: Deploy Alanxa App
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          debug: true
          script: |
            # Load environment variables (fix for non-interactive shell)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$HOME/.profile" ] && source $HOME/.profile
            [ -s "$HOME/.bashrc" ] && source $HOME/.bashrc
            
            set -e

            echo "ğŸ” Debug: Check Node version"
            node -v
            npm -v

            echo "ğŸ“‚ Move to project directory"
            if [ -d "/var/www/alanxa.ai" ]; then
              cd /var/www/alanxa.ai
            else
              echo "âŒ Directory /var/www/alanxa.ai does not exist!"
              exit 1
            fi

            echo "ğŸ”„ Pull latest code"
            git reset --hard
            git pull origin main

            echo "ğŸš€ Backend setup"
            cd server
            npm install
            # Use --update-env to ensure PM2 gets new env vars if needed
            pm2 restart alanxa-api --update-env || pm2 start index.js --name alanxa-api

            echo "ğŸ¨ Frontend build"
            cd ../client
            npm install
            npm run build

            echo "ğŸ” Reload nginx"
            # reloading nginx might require sudo, check if user has permissions
            sudo systemctl reload nginx
